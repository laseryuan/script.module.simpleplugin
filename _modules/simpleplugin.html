
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>simpleplugin &#8212; SimplePlugin 3.0.2 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for simpleplugin</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># Created on: 03.06.2015</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">SimplePlugin micro-framework for Kodi content plugins</span>

<span class="sd">**Author**: Roman Miroshnychenko aka Roman V.M.</span>

<span class="sd">**License**: `GPL v.3 &lt;https://www.gnu.org/copyleft/gpl.html&gt;`_</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>
<span class="kn">from</span> <span class="nn">future.builtins</span> <span class="kn">import</span> <span class="p">(</span><span class="nb">zip</span><span class="p">,</span> <span class="nb">super</span><span class="p">,</span>
                             <span class="nb">bytes</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">future.utils</span> <span class="kn">import</span> <span class="p">(</span><span class="n">PY2</span><span class="p">,</span> <span class="n">PY3</span><span class="p">,</span> <span class="n">iteritems</span><span class="p">,</span> <span class="n">itervalues</span><span class="p">,</span>
                          <span class="n">python_2_unicode_compatible</span><span class="p">)</span>
<span class="c1"># from future.standard_library import install_aliases</span>
<span class="c1"># install_aliases()</span>

<span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
    <span class="n">basestring</span> <span class="o">=</span> <span class="nb">str</span>
    <span class="n">long</span> <span class="o">=</span> <span class="nb">int</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">MutableMapping</span><span class="p">,</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">copyfile</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pformat</span>
<span class="kn">from</span> <span class="nn">platform</span> <span class="kn">import</span> <span class="n">uname</span>
<span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlencode</span><span class="p">,</span> <span class="n">quote_plus</span><span class="p">,</span> <span class="n">urlparse</span><span class="p">,</span> <span class="n">unquote_plus</span><span class="p">,</span> <span class="n">parse_qs</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">future.backports.urllib.parse</span> <span class="kn">import</span> <span class="n">urlencode</span><span class="p">,</span> <span class="n">quote_plus</span><span class="p">,</span> <span class="n">urlparse</span><span class="p">,</span> <span class="n">unquote_plus</span>
    <span class="kn">from</span> <span class="nn">urlparse</span> <span class="kn">import</span> <span class="n">parse_qs</span>
<span class="kn">import</span> <span class="nn">xbmcaddon</span>
<span class="kn">import</span> <span class="nn">xbmc</span>
<span class="kn">import</span> <span class="nn">xbmcgui</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SimplePluginError&#39;</span><span class="p">,</span> <span class="s1">&#39;Storage&#39;</span><span class="p">,</span> <span class="s1">&#39;MemStorage&#39;</span><span class="p">,</span> <span class="s1">&#39;Addon&#39;</span><span class="p">,</span> <span class="s1">&#39;Plugin&#39;</span><span class="p">,</span>
           <span class="s1">&#39;RoutedPlugin&#39;</span><span class="p">,</span> <span class="s1">&#39;Params&#39;</span><span class="p">,</span> <span class="s1">&#39;log_exception&#39;</span><span class="p">,</span> <span class="s1">&#39;py2_encode&#39;</span><span class="p">,</span>
           <span class="s1">&#39;py2_decode&#39;</span><span class="p">]</span>

<span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
    <span class="n">getargspec</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">getargspec</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span>

<span class="n">Route</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Route&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;pattern&#39;</span><span class="p">,</span> <span class="s1">&#39;func&#39;</span><span class="p">])</span>


<div class="viewcode-block" id="SimplePluginError"><a class="viewcode-back" href="../_autosummary/simpleplugin.html#simpleplugin.SimplePluginError">[docs]</a><span class="k">class</span> <span class="nc">SimplePluginError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Custom exception&quot;&quot;&quot;</span>
    <span class="k">pass</span></div>


<span class="k">class</span> <span class="nc">TimeoutError</span><span class="p">(</span><span class="n">SimplePluginError</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">_format_vars</span><span class="p">(</span><span class="n">variables</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Format variables dictionary</span>

<span class="sd">    :param variables: variables dict</span>
<span class="sd">    :type variables: dict</span>
<span class="sd">    :return: formatted string with sorted ``var = val`` pairs</span>
<span class="sd">    :rtype: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">var_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">var</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">variables</span><span class="p">)]</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">var_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">var</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)):</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> = </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">pformat</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>


<div class="viewcode-block" id="py2_encode"><a class="viewcode-back" href="../_autosummary/simpleplugin.html#simpleplugin.py2_encode">[docs]</a><span class="k">def</span> <span class="nf">py2_encode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Encode Python 2 ``unicode`` to ``str``</span>

<span class="sd">    In Python 3 the string is not changed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">PY2</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span></div>


<div class="viewcode-block" id="py2_decode"><a class="viewcode-back" href="../_autosummary/simpleplugin.html#simpleplugin.py2_decode">[docs]</a><span class="k">def</span> <span class="nf">py2_decode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decode Python 2 ``str`` to ``unicode``</span>

<span class="sd">    In Python 3 the string is not changed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">PY2</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span></div>


<div class="viewcode-block" id="log_exception"><a class="viewcode-back" href="../_autosummary/simpleplugin.html#simpleplugin.log_exception">[docs]</a><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">log_exception</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Diagnostic helper context manager</span>

<span class="sd">    It controls execution within its context and writes extended</span>
<span class="sd">    diagnostic info to the Kodi log if an unhandled exception</span>
<span class="sd">    happens within the context. The info includes the following items:</span>

<span class="sd">    - System info</span>
<span class="sd">    - Kodi version</span>
<span class="sd">    - Module path.</span>
<span class="sd">    - Code fragment where the exception has happened.</span>
<span class="sd">    - Global variables.</span>
<span class="sd">    - Local variables.</span>

<span class="sd">    After logging the diagnostic info the exception is re-raised.</span>

<span class="sd">    Example::</span>

<span class="sd">        with log_exception():</span>
<span class="sd">            # Some risky code</span>
<span class="sd">            raise RuntimeError(&#39;Fatal error!&#39;)</span>

<span class="sd">    :param logger: logger function which must accept a single argument</span>
<span class="sd">        which is a log message. By default it is :func:`xbmc.log`</span>
<span class="sd">        with ``ERROR`` level.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">msg</span><span class="p">:</span> <span class="n">xbmc</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">py2_encode</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="n">xbmc</span><span class="o">.</span><span class="n">LOGERROR</span><span class="p">)</span>
        <span class="n">frame_info</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="mi">5</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">logger</span><span class="p">(</span><span class="s1">&#39;Unhandled exception detected!&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="p">(</span><span class="s1">&#39;*** Start diagnostic info ***&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="p">(</span><span class="s1">&#39;System info: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uname</span><span class="p">()))</span>
        <span class="n">logger</span><span class="p">(</span><span class="s1">&#39;OS info: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">py2_decode</span><span class="p">(</span><span class="n">xbmc</span><span class="o">.</span><span class="n">getInfoLabel</span><span class="p">(</span><span class="s1">&#39;System.OSVersionInfo&#39;</span><span class="p">))))</span>
        <span class="n">logger</span><span class="p">(</span><span class="s1">&#39;Kodi version: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">xbmc</span><span class="o">.</span><span class="n">getInfoLabel</span><span class="p">(</span><span class="s1">&#39;System.BuildVersion&#39;</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="p">(</span><span class="s1">&#39;File: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frame_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">context</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">frame_info</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frame_info</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">frame_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">frame_info</span><span class="p">[</span><span class="mi">5</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">frame_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="n">context</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">:&gt;</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">line</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">context</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">line</span><span class="p">)</span>
        <span class="n">logger</span><span class="p">(</span><span class="s1">&#39;Code context:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">context</span><span class="p">)</span>
        <span class="n">logger</span><span class="p">(</span><span class="s1">&#39;Global variables:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">_format_vars</span><span class="p">(</span><span class="n">frame_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">f_globals</span><span class="p">))</span>
        <span class="n">logger</span><span class="p">(</span><span class="s1">&#39;Local variables:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">_format_vars</span><span class="p">(</span><span class="n">frame_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">f_locals</span><span class="p">))</span>
        <span class="n">logger</span><span class="p">(</span><span class="s1">&#39;**** End diagnostic info ****&#39;</span><span class="p">)</span>
        <span class="k">raise</span></div>


<div class="viewcode-block" id="Params"><a class="viewcode-back" href="../_autosummary/simpleplugin.html#simpleplugin.Params">[docs]</a><span class="nd">@python_2_unicode_compatible</span>
<span class="k">class</span> <span class="nc">Params</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Params(**kwargs)</span>

<span class="sd">    A class that stores parsed plugin call parameters</span>

<span class="sd">    Parameters can be accessed both through :class:`dict` keys and</span>
<span class="sd">    instance properties.</span>

<span class="sd">    .. note:: For a missing parameter an instance property returns ``None``.</span>

<span class="sd">    Example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        @plugin.action(&#39;foo&#39;)</span>
<span class="sd">        def action(params):</span>
<span class="sd">            foo = params[&#39;foo&#39;]  # Access by key</span>
<span class="sd">            bar = params.bar  # Access through property. Both variants are equal</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;Params </span><span class="si">{0}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">super</span><span class="p">(</span><span class="n">Params</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__str__</span><span class="p">())</span></div>


<div class="viewcode-block" id="Storage"><a class="viewcode-back" href="../_autosummary/simpleplugin.html#simpleplugin.Storage">[docs]</a><span class="nd">@python_2_unicode_compatible</span>
<span class="k">class</span> <span class="nc">Storage</span><span class="p">(</span><span class="n">MutableMapping</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Storage(storage_dir, filename=&#39;storage.pcl&#39;)</span>

<span class="sd">    Persistent storage for arbitrary data with a dictionary-like interface</span>

<span class="sd">    It is designed as a context manager and better be used</span>
<span class="sd">    with &#39;with&#39; statement.</span>

<span class="sd">    :param storage_dir: directory for storage</span>
<span class="sd">    :type storage_dir: str</span>
<span class="sd">    :param filename: the name of a storage file (optional)</span>
<span class="sd">    :type filename: str</span>

<span class="sd">    Usage::</span>

<span class="sd">        with Storage(&#39;/foo/bar/storage/&#39;) as storage:</span>
<span class="sd">            storage[&#39;key1&#39;] = value1</span>
<span class="sd">            value2 = storage[&#39;key2&#39;]</span>

<span class="sd">    .. note:: After exiting :keyword:`with` block a :class:`Storage` instance</span>
<span class="sd">        is invalidated. Storage contents are saved to disk only for</span>
<span class="sd">        a new storage or if the contents have been changed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">storage_dir</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;storage.pcl&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class constructor</span>

<span class="sd">        :type storage_dir: str</span>
<span class="sd">        :type filename: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hash</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">storage_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fo</span><span class="p">:</span>
                <span class="n">contents</span> <span class="o">=</span> <span class="n">fo</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PickleError</span><span class="p">,</span> <span class="ne">EOFError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;Storage </span><span class="si">{0}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="p">)</span>

<div class="viewcode-block" id="Storage.flush"><a class="viewcode-back" href="../_autosummary/simpleplugin.html#simpleplugin.Storage.flush">[docs]</a>    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save storage contents to disk</span>

<span class="sd">        This method saves new and changed :class:`Storage` contents to disk</span>
<span class="sd">        and invalidates the Storage instance. Unchanged Storage is not saved</span>
<span class="sd">        but simply invalidated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hash</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hash</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">+</span> <span class="s1">&#39;.tmp&#39;</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tmp</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="mf">2.0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span>
                        <span class="s1">&#39;Exceeded timeout for saving </span><span class="si">{0}</span><span class="s1"> contents!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">xbmc</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fo</span><span class="p">:</span>
                    <span class="n">fo</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
                <span class="n">copyfile</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_storage</span></div>

<div class="viewcode-block" id="Storage.copy"><a class="viewcode-back" href="../_autosummary/simpleplugin.html#simpleplugin.Storage.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make a copy of storage contents</span>

<span class="sd">        .. note:: this method performs a *deep* copy operation.</span>

<span class="sd">        :return: a copy of storage contents</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_storage</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MemStorage"><a class="viewcode-back" href="../_autosummary/simpleplugin.html#simpleplugin.MemStorage">[docs]</a><span class="nd">@python_2_unicode_compatible</span>
<span class="k">class</span> <span class="nc">MemStorage</span><span class="p">(</span><span class="n">MutableMapping</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    MemStorage(storage_id)</span>

<span class="sd">    In-memory storage with dict-like interface</span>

<span class="sd">    The data is stored in the Kodi core so contents of a MemStorage instance</span>
<span class="sd">    with the same ID can be shared between different Python processes.</span>

<span class="sd">    .. note:: Keys are case-insensitive</span>

<span class="sd">    .. warning:: :class:`MemStorage` does not allow to modify mutable objects</span>
<span class="sd">        in place! You need to assign them to variables first, modify and</span>
<span class="sd">        store them back to a MemStorage instance.</span>

<span class="sd">    Example:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        storage = MemStorage(&#39;foo&#39;)</span>
<span class="sd">        some_list = storage[&#39;bar&#39;]</span>
<span class="sd">        some_list.append(&#39;spam&#39;)</span>
<span class="sd">        storage[&#39;bar&#39;] = some_list</span>

<span class="sd">    :param storage_id: ID of this storage instance</span>
<span class="sd">    :type storage_id: str</span>
<span class="sd">    :param window_id: the ID of a Kodi Window object where storage contents</span>
<span class="sd">        will be stored.</span>
<span class="sd">    :type window_id: int</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">storage_id</span><span class="p">,</span> <span class="n">window_id</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :type storage_id: str</span>
<span class="sd">        :type window_id: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="n">storage_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_window</span> <span class="o">=</span> <span class="n">xbmcgui</span><span class="o">.</span><span class="n">Window</span><span class="p">(</span><span class="n">window_id</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;__keys__&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;__keys__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_check_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :type key: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Storage key must be of str type!&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_format_contents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">: </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
        <span class="k">return</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;MemStorage {{</span><span class="si">{0}</span><span class="s1">}}&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_format_contents</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">full_key</span> <span class="o">=</span> <span class="n">py2_encode</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">__</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
        <span class="n">raw_item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_window</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="n">full_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">raw_item</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">raw_item</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">raw_item</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">full_key</span> <span class="o">=</span> <span class="n">py2_encode</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">__</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
        <span class="c1"># protocol=0 is needed for safe string handling in Python 3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_window</span><span class="o">.</span><span class="n">setProperty</span><span class="p">(</span><span class="n">full_key</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;__keys__&#39;</span><span class="p">:</span>
            <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;__keys__&#39;</span><span class="p">]</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;__keys__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">keys</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">full_key</span> <span class="o">=</span> <span class="n">py2_encode</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">__</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_window</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="n">full_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_window</span><span class="o">.</span><span class="n">clearProperty</span><span class="p">(</span><span class="n">full_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">!=</span> <span class="s1">&#39;__keys__&#39;</span><span class="p">:</span>
                <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;__keys__&#39;</span><span class="p">]</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;__keys__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">keys</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">full_key</span> <span class="o">=</span> <span class="n">py2_encode</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">__</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_id</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
        <span class="n">item</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_window</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="n">full_key</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;__keys__&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;__keys__&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="Addon"><a class="viewcode-back" href="../_autosummary/simpleplugin.html#simpleplugin.Addon">[docs]</a><span class="nd">@python_2_unicode_compatible</span>
<span class="k">class</span> <span class="nc">Addon</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base addon class</span>

<span class="sd">    Provides access to basic addon parameters</span>

<span class="sd">    :param id_: addon id, e.g. &#39;plugin.video.foo&#39; (optional)</span>
<span class="sd">    :type id_: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class constructor</span>

<span class="sd">        :type id_: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_addon</span> <span class="o">=</span> <span class="n">xbmcaddon</span><span class="o">.</span><span class="n">Addon</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_profile_dir</span> <span class="o">=</span> <span class="n">py2_decode</span><span class="p">(</span>
            <span class="n">xbmc</span><span class="o">.</span><span class="n">translatePath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_addon</span><span class="o">.</span><span class="n">getAddonInfo</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ui_strings_map</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_profile_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_profile_dir</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;Addon [</span><span class="si">{0}</span><span class="s1">]&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">addon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Kodi Addon instance that represents this Addon</span>

<span class="sd">        :return: Addon instance</span>
<span class="sd">        :rtype: xbmcaddon.Addon</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_addon</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Addon ID</span>

<span class="sd">        :return: Addon ID, e.g. &#39;plugin.video.foo&#39;</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_addon</span><span class="o">.</span><span class="n">getAddonInfo</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Addon path</span>

<span class="sd">        :return: path to the addon folder</span>
<span class="sd">        :rtype: unicode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">py2_decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_addon</span><span class="o">.</span><span class="n">getAddonInfo</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">icon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Addon icon</span>

<span class="sd">        :return: path to the addon icon image</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">icon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_addon</span><span class="o">.</span><span class="n">getAddonInfo</span><span class="p">(</span><span class="s1">&#39;icon&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">icon</span><span class="p">:</span>
            <span class="n">icon</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;icon.png&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">icon</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">icon</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fanart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Addon fanart</span>

<span class="sd">        :return: path to the addon fanart image</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fanart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_addon</span><span class="o">.</span><span class="n">getAddonInfo</span><span class="p">(</span><span class="s1">&#39;fanart&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">fanart</span> <span class="p">:</span>
            <span class="n">fanart</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;fanart.jpg&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fanart</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">fanart</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">profile_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Addon config dir</span>

<span class="sd">        :return: path to the addon profile dir</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_profile_dir</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Addon version</span>

<span class="sd">        :return: addon version</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_addon</span><span class="o">.</span><span class="n">getAddonInfo</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Addon name</span>

<span class="sd">        :return: addon name</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_addon</span><span class="o">.</span><span class="n">getAddonInfo</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">author</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Addon author</span>

<span class="sd">        :return: addon author</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_addon</span><span class="o">.</span><span class="n">getAddonInfo</span><span class="p">(</span><span class="s1">&#39;author&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">changelog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Addon changelog</span>

<span class="sd">        :return: addon changelog</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_addon</span><span class="o">.</span><span class="n">getAddonInfo</span><span class="p">(</span><span class="s1">&#39;changelog&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Addon description</span>

<span class="sd">        :return: addon description</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_addon</span><span class="o">.</span><span class="n">getAddonInfo</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">disclaimer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Addon disclaimer</span>

<span class="sd">        :return: addon disclaimer</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_addon</span><span class="o">.</span><span class="n">getAddonInfo</span><span class="p">(</span><span class="s1">&#39;disclaimer&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">stars</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Addon stars</span>

<span class="sd">        :return: addon stars</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_addon</span><span class="o">.</span><span class="n">getAddonInfo</span><span class="p">(</span><span class="s1">&#39;stars&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Addon summary</span>

<span class="sd">        :return: addon summary</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_addon</span><span class="o">.</span><span class="n">getAddonInfo</span><span class="p">(</span><span class="s1">&#39;summary&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Addon type</span>

<span class="sd">        :return: addon type</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_addon</span><span class="o">.</span><span class="n">getAddonInfo</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Addon.get_localized_string"><a class="viewcode-back" href="../_autosummary/simpleplugin.html#simpleplugin.Addon.get_localized_string">[docs]</a>    <span class="k">def</span> <span class="nf">get_localized_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get localized UI string</span>

<span class="sd">        :param id_: UI string ID</span>
<span class="sd">        :type id_: int</span>
<span class="sd">        :return: UI string in the current language</span>
<span class="sd">        :rtype: unicode</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_addon</span><span class="o">.</span><span class="n">getLocalizedString</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span></div>

<div class="viewcode-block" id="Addon.get_setting"><a class="viewcode-back" href="../_autosummary/simpleplugin.html#simpleplugin.Addon.get_setting">[docs]</a>    <span class="k">def</span> <span class="nf">get_setting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_</span><span class="p">,</span> <span class="n">convert</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get addon setting</span>

<span class="sd">        If ``convert=True``, &#39;bool&#39; settings are converted to Python</span>
<span class="sd">        :class:`bool` values, and numeric strings to Python :class:`long` or</span>
<span class="sd">        :class:`float` depending on their format.</span>

<span class="sd">        .. note:: Settings can also be read via :class:`Addon` instance</span>
<span class="sd">            poperties named as the respective settings. I.e. ``addon.foo``</span>
<span class="sd">            is equal to ``addon.get_setting(&#39;foo&#39;)``.</span>

<span class="sd">        :param id_: setting ID</span>
<span class="sd">        :type id_: str</span>
<span class="sd">        :param convert: try to guess and convert the setting to an appropriate type</span>
<span class="sd">            E.g. ``&#39;1.0&#39;`` will be converted to float ``1.0`` number,</span>
<span class="sd">            ``&#39;true&#39;`` to ``True`` and so on.</span>
<span class="sd">        :type convert: bool</span>
<span class="sd">        :return: setting value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">setting</span> <span class="o">=</span> <span class="n">py2_decode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_addon</span><span class="o">.</span><span class="n">getSetting</span><span class="p">(</span><span class="n">id_</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">convert</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">setting</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># Convert boolean strings to bool</span>
            <span class="k">elif</span> <span class="n">setting</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^-?\d+$&#39;</span><span class="p">,</span> <span class="n">setting</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">long</span><span class="p">(</span><span class="n">setting</span><span class="p">)</span>  <span class="c1"># Convert numeric strings to long</span>
            <span class="k">elif</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^-?\d+\.\d+$&#39;</span><span class="p">,</span> <span class="n">setting</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">setting</span><span class="p">)</span>  <span class="c1"># Convert numeric strings with a dot to float</span>
        <span class="k">return</span> <span class="n">setting</span></div>

<div class="viewcode-block" id="Addon.set_setting"><a class="viewcode-back" href="../_autosummary/simpleplugin.html#simpleplugin.Addon.set_setting">[docs]</a>    <span class="k">def</span> <span class="nf">set_setting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set addon setting</span>

<span class="sd">        Python :class:`bool` type are converted to ``&#39;true&#39;`` or ``&#39;false&#39;``</span>
<span class="sd">        Non-string/non-unicode values are converted to strings.</span>

<span class="sd">        .. warning:: Setting values via :class:`Addon` instance properties</span>
<span class="sd">            is not supported! Values can only be set using</span>
<span class="sd">            :meth:`Addon.set_setting` method.</span>

<span class="sd">        :param id_: setting ID</span>
<span class="sd">        :type id_: str</span>
<span class="sd">        :param value: setting value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;true&#39;</span> <span class="k">if</span> <span class="n">value</span> <span class="k">else</span> <span class="s1">&#39;false&#39;</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_addon</span><span class="o">.</span><span class="n">setSetting</span><span class="p">(</span><span class="n">id_</span><span class="p">,</span> <span class="n">py2_encode</span><span class="p">(</span><span class="n">value</span><span class="p">))</span></div>

<div class="viewcode-block" id="Addon.log"><a class="viewcode-back" href="../_autosummary/simpleplugin.html#simpleplugin.Addon.log">[docs]</a>    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="n">xbmc</span><span class="o">.</span><span class="n">LOGDEBUG</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add message to Kodi log starting with Addon ID</span>

<span class="sd">        :param message: message to be written into the Kodi log</span>
<span class="sd">        :type message: str</span>
<span class="sd">        :param level: log level. :mod:`xbmc` module provides the necessary</span>
<span class="sd">            symbolic constants. Default: ``xbmc.LOGDEBUG``</span>
<span class="sd">        :type level: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xbmc</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="n">py2_encode</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> [v.</span><span class="si">{1}</span><span class="s1">]: </span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">message</span><span class="p">)),</span>
            <span class="n">level</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Addon.log_notice"><a class="viewcode-back" href="../_autosummary/simpleplugin.html#simpleplugin.Addon.log_notice">[docs]</a>    <span class="k">def</span> <span class="nf">log_notice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add NOTICE message to the Kodi log</span>

<span class="sd">        :param message: message to write to the Kodi log</span>
<span class="sd">        :type message: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">xbmc</span><span class="o">.</span><span class="n">LOGNOTICE</span><span class="p">)</span></div>

<div class="viewcode-block" id="Addon.log_warning"><a class="viewcode-back" href="../_autosummary/simpleplugin.html#simpleplugin.Addon.log_warning">[docs]</a>    <span class="k">def</span> <span class="nf">log_warning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add WARNING message to the Kodi log</span>

<span class="sd">        :param message: message to write to the Kodi log</span>
<span class="sd">        :type message: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">xbmc</span><span class="o">.</span><span class="n">LOGWARNING</span><span class="p">)</span></div>

<div class="viewcode-block" id="Addon.log_error"><a class="viewcode-back" href="../_autosummary/simpleplugin.html#simpleplugin.Addon.log_error">[docs]</a>    <span class="k">def</span> <span class="nf">log_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add ERROR message to the Kodi log</span>

<span class="sd">        :param message: message to write to the Kodi log</span>
<span class="sd">        :type message: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">xbmc</span><span class="o">.</span><span class="n">LOGERROR</span><span class="p">)</span></div>

<div class="viewcode-block" id="Addon.log_debug"><a class="viewcode-back" href="../_autosummary/simpleplugin.html#simpleplugin.Addon.log_debug">[docs]</a>    <span class="k">def</span> <span class="nf">log_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add debug message to the Kodi log</span>

<span class="sd">        :param message: message to write to the Kodi log</span>
<span class="sd">        :type message: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">xbmc</span><span class="o">.</span><span class="n">LOGDEBUG</span><span class="p">)</span></div>

<div class="viewcode-block" id="Addon.get_storage"><a class="viewcode-back" href="../_autosummary/simpleplugin.html#simpleplugin.Addon.get_storage">[docs]</a>    <span class="k">def</span> <span class="nf">get_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;storage.pcl&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a persistent :class:`Storage` instance for storing arbitrary values</span>
<span class="sd">        between addon calls.</span>

<span class="sd">        A :class:`Storage` instance can be used as a context manager.</span>

<span class="sd">        Example::</span>

<span class="sd">            with plugin.get_storage() as storage:</span>
<span class="sd">                storage[&#39;param1&#39;] = value1</span>
<span class="sd">                value2 = storage[&#39;param2&#39;]</span>

<span class="sd">        .. note:: After exiting :keyword:`with` block a :class:`Storage`</span>
<span class="sd">            instance is invalidated.</span>

<span class="sd">        :param filename: the name of a storage file (optional)</span>
<span class="sd">        :type filename: str</span>
<span class="sd">        :return: Storage object</span>
<span class="sd">        :rtype: Storage</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Storage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">profile_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span></div>

<div class="viewcode-block" id="Addon.get_mem_storage"><a class="viewcode-back" href="../_autosummary/simpleplugin.html#simpleplugin.Addon.get_mem_storage">[docs]</a>    <span class="k">def</span> <span class="nf">get_mem_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">storage_id</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">window_id</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an in-memory storage for this addon with :class:`dict`-like</span>
<span class="sd">        interface</span>

<span class="sd">        The storage can store picklable Python objects as long as</span>
<span class="sd">        Kodi is running and storage contents can be shared between</span>
<span class="sd">        Python processes. Different addons have separate storages,</span>
<span class="sd">        so storages with the same names created with this method</span>
<span class="sd">        do not conflict.</span>

<span class="sd">        Example::</span>

<span class="sd">            addon = Addon()</span>
<span class="sd">            storage = addon.get_mem_storage()</span>
<span class="sd">            foo = storage[&#39;foo&#39;]</span>
<span class="sd">            storage[&#39;bar&#39;] = bar</span>

<span class="sd">        :param storage_id: optional storage ID (case-insensitive).</span>
<span class="sd">        :type storage_id: str</span>
<span class="sd">        :param window_id: the ID of a Kodi Window object where storage contents</span>
<span class="sd">            will be stored.</span>
<span class="sd">        :type window_id: int</span>
<span class="sd">        :return: in-memory storage for this addon</span>
<span class="sd">        :rtype: MemStorage</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">storage_id</span><span class="p">:</span>
            <span class="n">storage_id</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">storage_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">MemStorage</span><span class="p">(</span><span class="n">storage_id</span><span class="p">,</span> <span class="n">window_id</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_cached_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get data from a cache object</span>

<span class="sd">        :param cache: cache object</span>
<span class="sd">        :param func: function to cache</span>
<span class="sd">        :param duration: cache duration</span>
<span class="sd">        :param args: function args</span>
<span class="sd">        :param kwargs: function kwargs</span>
<span class="sd">        :return: function return data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">duration</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Caching duration cannot be zero or negative!&#39;</span><span class="p">)</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">timestamp</span> <span class="o">&gt;</span> <span class="n">duration</span> <span class="o">*</span> <span class="mi">60</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_debug</span><span class="p">(</span><span class="s1">&#39;Cache hit: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_debug</span><span class="p">(</span><span class="s1">&#39;Cache miss: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">current_time</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

<div class="viewcode-block" id="Addon.cached"><a class="viewcode-back" href="../_autosummary/simpleplugin.html#simpleplugin.Addon.cached">[docs]</a>    <span class="k">def</span> <span class="nf">cached</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cached decorator</span>

<span class="sd">        Used to cache function return data</span>

<span class="sd">        Usage::</span>

<span class="sd">            @plugin.cached(30)</span>
<span class="sd">            def my_func(*args, **kwargs):</span>
<span class="sd">                # Do some stuff</span>
<span class="sd">                return value</span>

<span class="sd">        :param duration: caching duration in min (positive values only)</span>
<span class="sd">        :type duration: int</span>
<span class="sd">        :raises ValueError: if duration is zero or negative</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">outer_wrapper</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">inner_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_storage</span><span class="p">(</span><span class="s1">&#39;__cache__.pcl&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cache</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cached_data</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span>
                                                 <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">inner_wrapper</span>
        <span class="k">return</span> <span class="n">outer_wrapper</span></div>

<div class="viewcode-block" id="Addon.mem_cached"><a class="viewcode-back" href="../_autosummary/simpleplugin.html#simpleplugin.Addon.mem_cached">[docs]</a>    <span class="k">def</span> <span class="nf">mem_cached</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        In-memory cache decorator</span>

<span class="sd">        Usage::</span>

<span class="sd">            @plugin.mem_cached(30)</span>
<span class="sd">            def my_func(*args, **kwargs):</span>
<span class="sd">                # Do some stuff</span>
<span class="sd">                return value</span>

<span class="sd">        :param duration: caching duration in min (positive values only)</span>
<span class="sd">        :type duration: int</span>
<span class="sd">        :raises ValueError: if duration is zero or negative</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">outer_wrapper</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">inner_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="n">cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mem_storage</span><span class="p">(</span><span class="s1">&#39;***cache***&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_cached_data</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span>
                                             <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">inner_wrapper</span>
        <span class="k">return</span> <span class="n">outer_wrapper</span></div>

<div class="viewcode-block" id="Addon.gettext"><a class="viewcode-back" href="../_autosummary/simpleplugin.html#simpleplugin.Addon.gettext">[docs]</a>    <span class="k">def</span> <span class="nf">gettext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ui_string</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a translated UI string from addon localization files.</span>

<span class="sd">        This function emulates GNU Gettext for more convenient access</span>
<span class="sd">        to localized addon UI strings. To reduce typing this method object</span>
<span class="sd">        can be assigned to a ``_`` (single underscore) variable.</span>

<span class="sd">        For using gettext emulation :meth:`Addon.initialize_gettext` method</span>
<span class="sd">        needs to be called first. See documentation for that method for more</span>
<span class="sd">        info about Gettext emulation.</span>

<span class="sd">        :param ui_string: a UI string from English :file:`strings.po`.</span>
<span class="sd">        :type ui_string: str</span>
<span class="sd">        :return: a UI string from translated :file:`strings.po`.</span>
<span class="sd">        :rtype: unicode</span>
<span class="sd">        :raises SimplePluginError: if :meth:`Addon.initialize_gettext`</span>
<span class="sd">            wasn&#39;t called first or if a string is not found in</span>
<span class="sd">            English :file:`strings.po`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ui_strings_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_localized_string</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ui_strings_map</span><span class="p">[</span><span class="s1">&#39;strings&#39;</span><span class="p">][</span><span class="n">ui_string</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SimplePluginError</span><span class="p">(</span>
                    <span class="s1">&#39;UI string &quot;</span><span class="si">{0}</span><span class="s1">&quot; is not found in strings.po!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">ui_string</span><span class="p">)</span>
                    <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SimplePluginError</span><span class="p">(</span><span class="s1">&#39;Addon localization is not initialized!&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Addon.initialize_gettext"><a class="viewcode-back" href="../_autosummary/simpleplugin.html#simpleplugin.Addon.initialize_gettext">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_gettext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize GNU gettext emulation in addon</span>

<span class="sd">        Kodi localization system for addons is not very convenient</span>
<span class="sd">        because you need to operate with numeric string codes instead</span>
<span class="sd">        of UI strings themselves which reduces code readability and</span>
<span class="sd">        may lead to errors. The :class:`Addon` class provides facilities</span>
<span class="sd">        for emulating GNU Gettext localization system.</span>

<span class="sd">        This allows to use UI strings from addon&#39;s English :file:`strings.po`</span>
<span class="sd">        file instead of numeric codes to return localized strings from</span>
<span class="sd">        respective localized :file:`.po` files.</span>

<span class="sd">        This method returns :meth:`Addon.gettext` method object that</span>
<span class="sd">        can be assigned to a short alias to reduce typing. Traditionally,</span>
<span class="sd">        ``_`` (a single underscore) is used for this purpose.</span>

<span class="sd">        Example::</span>

<span class="sd">            addon = simpleplugin.Addon()</span>
<span class="sd">            _ = addon.initialize_gettext()</span>

<span class="sd">            xbmcgui.Dialog().notification(_(&#39;Warning!&#39;), _(&#39;Something happened&#39;))</span>

<span class="sd">        In the preceding example the notification strings will be replaced</span>
<span class="sd">        with localized versions if these strings are translated.</span>

<span class="sd">        :return: :meth:`Addon.gettext` method object</span>
<span class="sd">        :raises SimplePluginError: if the addon&#39;s English :file:`strings.po`</span>
<span class="sd">            file is missing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">strings_po</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="s1">&#39;language&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;resource.language.en_gb&#39;</span><span class="p">,</span> <span class="s1">&#39;strings.po&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">strings_po</span><span class="p">):</span>
            <span class="n">strings_po</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="s1">&#39;language&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;English&#39;</span><span class="p">,</span> <span class="s1">&#39;strings.po&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">strings_po</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">strings_po</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fo</span><span class="p">:</span>
                <span class="n">raw_strings</span> <span class="o">=</span> <span class="n">fo</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">raw_strings_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">raw_strings</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
            <span class="n">ui_strings_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mem_storage</span><span class="p">(</span><span class="s1">&#39;__gettext__&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">raw_strings_hash</span> <span class="o">!=</span> <span class="n">ui_strings_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hash&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
                <span class="n">ui_strings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_po</span><span class="p">(</span>
                    <span class="n">raw_strings</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ui_strings_map</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;hash&#39;</span><span class="p">:</span> <span class="n">raw_strings_hash</span><span class="p">,</span>
                    <span class="s1">&#39;strings&#39;</span><span class="p">:</span> <span class="n">ui_strings</span>
                <span class="p">}</span>
                <span class="n">ui_strings_map</span><span class="p">[</span><span class="s1">&#39;hash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_strings_hash</span>
                <span class="n">ui_strings_map</span><span class="p">[</span><span class="s1">&#39;strings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ui_strings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ui_strings_map</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ui_strings_map</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ui_strings_map</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SimplePluginError</span><span class="p">(</span><span class="s1">&#39;Unable to initialize localization because &#39;</span>
                                    <span class="s1">&#39;of missing English strings.po!&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gettext</span></div>

    <span class="k">def</span> <span class="nf">_parse_po</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parses ``strings.po`` file into a dict of {&#39;string&#39;: id} items.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ui_strings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">string_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">string</span> <span class="ow">in</span> <span class="n">strings</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">string_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;msgctxt&#39;</span> <span class="ow">in</span> <span class="n">string</span><span class="p">:</span>
                <span class="n">string_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&quot;#(\d+)&quot;&#39;</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">U</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">string_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s1">&#39;msgid&#39;</span> <span class="ow">in</span> <span class="n">string</span><span class="p">:</span>
                <span class="n">ui_strings</span><span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&quot;(.*?)&quot;&#39;</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">U</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">string_id</span>
                <span class="n">string_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">ui_strings</span></div>


<div class="viewcode-block" id="Plugin"><a class="viewcode-back" href="../_autosummary/simpleplugin.html#simpleplugin.Plugin">[docs]</a><span class="nd">@python_2_unicode_compatible</span>
<span class="k">class</span> <span class="nc">Plugin</span><span class="p">(</span><span class="n">Addon</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plugin class with URL query string routing.</span>

<span class="sd">    It provides a simplified plugin call routing mechanism using URL query strings.</span>
<span class="sd">    A URL query string must contain &quot;action&quot; parameter that defines which function</span>
<span class="sd">    will be invoked during this plugin call.</span>

<span class="sd">    :param id_: plugin&#39;s id, e.g. &#39;plugin.video.foo&#39; (optional)</span>
<span class="sd">    :type id_: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class constructor</span>

<span class="sd">        :type id_: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Plugin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">=</span> <span class="s1">&#39;plugin://</span><span class="si">{0}</span><span class="s1">/&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;Plugin </span><span class="si">{0}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get plugin call parameters</span>

<span class="sd">        :return: plugin call parameters</span>
<span class="sd">        :rtype: Params</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get plugin handle</span>

<span class="sd">        :return: plugin handle</span>
<span class="sd">        :rtype: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span>

<div class="viewcode-block" id="Plugin.get_params"><a class="viewcode-back" href="../_autosummary/simpleplugin.html#simpleplugin.Plugin.get_params">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_params</span><span class="p">(</span><span class="n">paramstring</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a URL-encoded paramstring to a Python dict</span>

<span class="sd">        :param paramstring: URL-encoded paramstring</span>
<span class="sd">        :type paramstring: str</span>
<span class="sd">        :return: parsed paramstring</span>
<span class="sd">        :rtype: Params</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">raw_params</span> <span class="o">=</span> <span class="n">parse_qs</span><span class="p">(</span><span class="n">paramstring</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">Params</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">raw_params</span><span class="p">):</span>
            <span class="n">param_value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">value</span>
            <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">py2_decode</span><span class="p">(</span><span class="n">param_value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">params</span></div>

<div class="viewcode-block" id="Plugin.get_url"><a class="viewcode-back" href="../_autosummary/simpleplugin.html#simpleplugin.Plugin.get_url">[docs]</a>    <span class="k">def</span> <span class="nf">get_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plugin_url</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a callable URL for a virtual directory item</span>

<span class="sd">        If plugin_url is empty, a current plugin URL is used.</span>
<span class="sd">        kwargs are converted to a URL-encoded string of plugin call parameters</span>
<span class="sd">        To call a plugin action, &#39;action&#39; parameter must be used,</span>
<span class="sd">        if &#39;action&#39; parameter is missing, then the plugin root action is called</span>
<span class="sd">        If the action is not added to :class:`Plugin` actions,</span>
<span class="sd">        :class:`PluginError` will be raised.</span>

<span class="sd">        :param plugin_url: plugin URL with trailing / (optional)</span>
<span class="sd">        :type plugin_url: str</span>
<span class="sd">        :param kwargs: pairs of key=value items</span>
<span class="sd">        :return: a full plugin callback URL</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">plugin_url</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">?</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">urlencode</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">doseq</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">url</span></div>

<div class="viewcode-block" id="Plugin.action"><a class="viewcode-back" href="../_autosummary/simpleplugin.html#simpleplugin.Plugin.action">[docs]</a>    <span class="k">def</span> <span class="nf">action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Action decorator</span>

<span class="sd">        Defines plugin callback action. If action&#39;s name is not defined</span>
<span class="sd">        explicitly, then the action is named after the decorated function.</span>

<span class="sd">        .. warning:: Action&#39;s name must be unique.</span>

<span class="sd">        A plugin must have at least one action named ``&#39;root&#39;``</span>
<span class="sd">        implicitly or explicitly.</span>

<span class="sd">        Example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            # The action is implicitly named &#39;root&#39; after the decorated function</span>
<span class="sd">            @plugin.action()</span>
<span class="sd">            def root(params):</span>
<span class="sd">                pass</span>

<span class="sd">            @plugin.action(&#39;foo&#39;)  # The action name is set explicitly</span>
<span class="sd">            def foo_action(params):</span>
<span class="sd">                pass</span>

<span class="sd">        :param name: action&#39;s name (optional).</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :raises SimplePluginError: if the action with such name is already defined.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SimplePluginError</span><span class="p">(</span>
                    <span class="s1">&#39;Action &quot;</span><span class="si">{0}</span><span class="s1">&quot; already defined!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
            <span class="k">return</span> <span class="n">func</span>
        <span class="k">return</span> <span class="n">wrap</span></div>

<div class="viewcode-block" id="Plugin.run"><a class="viewcode-back" href="../_autosummary/simpleplugin.html#simpleplugin.Plugin.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run plugin</span>

<span class="sd">        :raises SimplePluginError: if unknown action string is provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_params</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_debug</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_function</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SimplePluginError</span><span class="p">(</span>
                <span class="s1">&#39;A decorated function must not return any value! &#39;</span>
                <span class="s1">&#39;It returned </span><span class="si">{0}</span><span class="s1"> instead.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_resolve_function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resolve action from plugin call params and call the respective callable</span>
<span class="sd">        function</span>

<span class="sd">        :return: action callable&#39;s return value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_debug</span><span class="p">(</span><span class="s1">&#39;Actions: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">keys</span><span class="p">()))))</span>
        <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;action&#39;</span><span class="p">,</span> <span class="s1">&#39;root&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_debug</span><span class="p">(</span><span class="s1">&#39;Called action </span><span class="si">{0}</span><span class="s1"> with params </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">action</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">action_callable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">[</span><span class="n">action</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SimplePluginError</span><span class="p">(</span><span class="s1">&#39;Invalid action: &quot;</span><span class="si">{0}</span><span class="s1">&quot;!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">action</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">log_exception</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_error</span><span class="p">):</span>
                <span class="c1"># inspect.isfunction is needed for tests</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">action_callable</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="ow">not</span> <span class="n">getargspec</span><span class="p">(</span><span class="n">action_callable</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">action_callable</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">action_callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">)</span></div>


<div class="viewcode-block" id="RoutedPlugin"><a class="viewcode-back" href="../_autosummary/simpleplugin.html#simpleplugin.RoutedPlugin">[docs]</a><span class="nd">@python_2_unicode_compatible</span>
<span class="k">class</span> <span class="nc">RoutedPlugin</span><span class="p">(</span><span class="n">Plugin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plugin class that implements &quot;pretty URL&quot; routing similar to Flask and Bottle</span>
<span class="sd">    web-frameworks</span>

<span class="sd">    :param id_: plugin&#39;s id, e.g. &#39;plugin.video.foo&#39; (optional)</span>
<span class="sd">    :type id_: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param id_: plugin&#39;s id, e.g. &#39;plugin.video.foo&#39; (optional)</span>
<span class="sd">        :type id_: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RoutedPlugin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">id_</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_routes</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;&lt;RoutedPlugin </span><span class="si">{0}</span><span class="s1">&gt;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>

<div class="viewcode-block" id="RoutedPlugin.url_for"><a class="viewcode-back" href="../_autosummary/simpleplugin.html#simpleplugin.RoutedPlugin.url_for">[docs]</a>    <span class="k">def</span> <span class="nf">url_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a URL for a plugin route</span>

<span class="sd">        This method performs reverse resolving a plugin callback URL for</span>
<span class="sd">        the named route. If route&#39;s name is not set explicitly, then the name</span>
<span class="sd">        of a decorated function is used as the name of the corresponding route.</span>
<span class="sd">        The method can optionally take positional args and kwargs.</span>
<span class="sd">        If any positional args are provided their values replace</span>
<span class="sd">        variable placeholders by position.</span>

<span class="sd">        .. warning:: The number of positional args must not exceed</span>
<span class="sd">            the number of variable placeholders!</span>

<span class="sd">        If any kwargs are provided their values replace variable placeholders</span>
<span class="sd">        by name. If the number of kwargs provided exceeds the number of variable</span>
<span class="sd">        placeholders, then the rest of the kwargs are added to the URL</span>
<span class="sd">        as a query string.</span>

<span class="sd">        .. note:: All :class:`unicode` arguments are encoded with UTF-8 encoding.</span>

<span class="sd">        Let&#39;s assume that the ID of our plugin is ``plugin.acme``.</span>
<span class="sd">        The following examples will show how to use this method to resolve</span>
<span class="sd">        callback URLs for this plugin.</span>

<span class="sd">        Example 1::</span>

<span class="sd">            @plugin.route(&#39;/foo&#39;)</span>
<span class="sd">            def foo():</span>
<span class="sd">                pass</span>
<span class="sd">            url = plugin.url_for(&#39;foo&#39;)</span>
<span class="sd">            # url = &#39;plugin://plugin.acme/foo&#39;</span>

<span class="sd">        Example 2::</span>

<span class="sd">            @plugin.route(&#39;/foo/&lt;param&gt;&#39;)</span>
<span class="sd">            def foo(param):</span>
<span class="sd">                pass</span>
<span class="sd">            url = plugin.url_for(&#39;foo&#39;, param=&#39;bar&#39;)</span>
<span class="sd">            # url = &#39;plugin://plugin.acme/foo/bar&#39;</span>

<span class="sd">        Example 3::</span>

<span class="sd">            plugin.route(&#39;/foo/&lt;param&gt;&#39;)</span>
<span class="sd">            def foo(param):</span>
<span class="sd">                pass</span>
<span class="sd">            url = plugin.url_for(&#39;foo&#39;, param=&#39;bar&#39;, ham=&#39;spam&#39;)</span>
<span class="sd">            # url = &#39;plugin://plugin.acme/foo/bar?ham=spam</span>

<span class="sd">        :param func_: route&#39;s name or a decorated function object.</span>
<span class="sd">        :type func_: str or types.FunctionType</span>
<span class="sd">        :param args: positional arguments.</span>
<span class="sd">        :param kwargs: keyword arguments.</span>
<span class="sd">        :return: full plugin call URL for the route.</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        :raises simpleplugin.SimplePluginError: if a route with such name</span>
<span class="sd">            does not exist or on arguments mismatch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func_</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">func_</span>
        <span class="k">elif</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">func_</span><span class="p">)</span> <span class="ow">or</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">(</span><span class="n">func_</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">func_</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The first argument to url_for must be &#39;</span>
                            <span class="s1">&#39;a route</span><span class="se">\&#39;</span><span class="s1">s name or a route function object!&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_routes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">pattern</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SimplePluginError</span><span class="p">(</span><span class="s1">&#39;Route &quot;</span><span class="si">{0}</span><span class="s1">&quot; does not exist!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;/(&lt;\w+?&gt;)&#39;</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SimplePluginError</span><span class="p">(</span>
                <span class="s1">&#39;Arguments for the route &quot;</span><span class="si">{0}</span><span class="s1">&quot; &#39;</span>
                <span class="s1">&#39;do not match placeholders!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">matches</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">match</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">matches</span><span class="p">):</span>
                <span class="n">pattern</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="n">match</span><span class="p">,</span>
                    <span class="n">quote_plus</span><span class="p">(</span><span class="n">py2_encode</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">arg</span><span class="p">)))</span>
                <span class="p">)</span>
            <span class="c1"># list allows to manipulate the dict during iteration</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">iteritems</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">):]:</span>

                    <span class="n">match_string</span> <span class="o">=</span> <span class="n">match</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">match_parts</span> <span class="o">=</span> <span class="n">match_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">match_parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">match_string</span> <span class="o">=</span> <span class="n">match_parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">match_string</span><span class="p">:</span>
                        <span class="n">pattern</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                            <span class="n">match</span><span class="p">,</span> <span class="n">quote_plus</span><span class="p">(</span><span class="n">py2_encode</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                        <span class="p">)</span>
                        <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;plugin://</span><span class="si">{0}{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">+=</span> <span class="s1">&#39;?&#39;</span> <span class="o">+</span> <span class="n">urlencode</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">doseq</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">url</span></div>

    <span class="n">get_url</span> <span class="o">=</span> <span class="n">url_for</span>

<div class="viewcode-block" id="RoutedPlugin.route"><a class="viewcode-back" href="../_autosummary/simpleplugin.html#simpleplugin.RoutedPlugin.route">[docs]</a>    <span class="k">def</span> <span class="nf">route</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Route decorator for plugin callback routes</span>

<span class="sd">        The route decorator is used to define plugin callback routes</span>
<span class="sd">        similar to a URL routing mechanism in Flask and Bottle Python</span>
<span class="sd">        web-frameworks. The plugin routing mechanism calls decorated functions</span>
<span class="sd">        by matching a path in a plugin callback URL (passed as ``sys.argv[0]``)</span>
<span class="sd">        to a route pattern. A route pattern *must* start with a forward slash</span>
<span class="sd">        ``/``. An end slash is optional. A plugin must have at least the root</span>
<span class="sd">        route with ``&#39;/&#39;`` pattern. Bu default a route is named by the decorated</span>
<span class="sd">        function, but route&#39;s name can be set explicitly by providing</span>
<span class="sd">        the 2nd optional ``name`` argument.</span>

<span class="sd">        .. warning:: Route names must be unique!</span>

<span class="sd">        Example 1::</span>

<span class="sd">            @plugin.route(&#39;/foo&#39;)</span>
<span class="sd">            def foo_function():</span>
<span class="sd">                pass</span>

<span class="sd">        In the preceding example ``foo_function`` will be called when the plugin</span>
<span class="sd">        is invoked with ``plugin://plugin.acme/foo/`` callback URL.</span>
<span class="sd">        A route pattern can contain variable placeholders</span>
<span class="sd">        (marked with angular brackets ``&lt;&gt;``) that are used to pass arguments</span>
<span class="sd">        to a route function.</span>

<span class="sd">        Example 2::</span>

<span class="sd">            @plugin.route(&#39;/foo/&lt;param&gt;&#39;)</span>
<span class="sd">            def foo_function(param):</span>
<span class="sd">                pass</span>

<span class="sd">        In the preceding example the part of a callback path marked with</span>
<span class="sd">        ``&lt;param&gt;`` placeholder will be passed to the function as an argument.</span>
<span class="sd">        The name of a placeholder must be the same as the name of</span>
<span class="sd">        the corresponding parameter. By default arguments are passed as strings.</span>
<span class="sd">        The ``int`` and ``float`` prefixes can be used to pass arguments</span>
<span class="sd">        as :class:`int` and :class:`float` numbers, for example ``&lt;int:foo&gt;``</span>
<span class="sd">        or ``&lt;float:bar&gt;``.</span>

<span class="sd">        Example 3::</span>

<span class="sd">            @plugin.route(&#39;/add/&lt;int:param1&gt;/&lt;int:param2&gt;&#39;)</span>
<span class="sd">            def addition(param1, param2):</span>
<span class="sd">                sum = param1 + param2</span>

<span class="sd">        A function can have multiple route decorators. In this case additional</span>
<span class="sd">        routes must have explicitly defined names. If a route has less variable</span>
<span class="sd">        placeholders than function parameters, &quot;missing&quot; function parameters</span>
<span class="sd">        must have default values.</span>

<span class="sd">        Example 4::</span>

<span class="sd">            @plugin.route(&#39;/foo/&lt;param&gt;&#39;, name=&#39;foo_route&#39;)</span>
<span class="sd">            @plugin.route(&#39;/bar&#39;)</span>
<span class="sd">            def some_function(param=&#39;spam&#39;):</span>
<span class="sd">                # Do something</span>

<span class="sd">        In the preceding example ``some_function`` can be called through</span>
<span class="sd">        2 possible routes. If the function is called through the 1st route</span>
<span class="sd">        (``&#39;foo_route&#39;``) ``&lt;param&gt;`` value will be passed as an argument.</span>
<span class="sd">        The 2nd route will call the function with the default argument</span>
<span class="sd">        ``&#39;spam&#39;`` because this route has no variable placeholders to pass</span>
<span class="sd">        arguments to the function. The order of the ``route`` decorators</span>
<span class="sd">        does not matter but each route must have a unique name.</span>

<span class="sd">        .. note:: A route pattern must start with a forward slash ``/``</span>
<span class="sd">            and must not have a slash at the end.</span>

<span class="sd">        :param pattern: route matching pattern</span>
<span class="sd">        :type pattern: str</span>
<span class="sd">        :param name: route&#39;s name (optional). If no name is provided,</span>
<span class="sd">            the route is named after the decorated function.</span>
<span class="sd">            The name must be unique.</span>
<span class="sd">        :type name: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_routes</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SimplePluginError</span><span class="p">(</span>
                    <span class="s1">&#39;The route &quot;</span><span class="si">{0}</span><span class="s1">&quot; already exists!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;int:&#39;</span><span class="p">,</span> <span class="s1">&#39;int__&#39;</span>
                                      <span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;float:&#39;</span><span class="p">,</span> <span class="s1">&#39;float__&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_routes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Route</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">func</span>
        <span class="k">return</span> <span class="n">wrapper</span></div>

    <span class="k">def</span> <span class="nf">_resolve_function</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resolve route from plugin callback path and call the respective</span>
<span class="sd">        route function</span>

<span class="sd">        :return: route function&#39;s return value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_debug</span><span class="p">(</span><span class="s1">&#39;Routes: </span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_routes</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">route</span> <span class="ow">in</span> <span class="n">itervalues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_routes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">route</span><span class="o">.</span><span class="n">pattern</span> <span class="o">==</span> <span class="n">path</span><span class="p">:</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_debug</span><span class="p">(</span>
                    <span class="s1">&#39;Calling </span><span class="si">{0}</span><span class="s1"> with kwargs </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
                <span class="k">with</span> <span class="n">log_exception</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_error</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">route</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">route</span> <span class="ow">in</span> <span class="n">itervalues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_routes</span><span class="p">):</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">route</span><span class="o">.</span><span class="n">pattern</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">path</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">pattern</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">subn</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;/(&lt;\w+?&gt;)&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;/(?P\1.+?)&#39;</span><span class="p">,</span> <span class="n">pattern</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">count</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^&#39;</span> <span class="o">+</span> <span class="n">pattern</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;$&#39;</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()</span>
                <span class="c1"># list allows to manipulate the dict during iteration</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">iteritems</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;int__&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;float__&#39;</span><span class="p">):</span>
                        <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;int__&#39;</span><span class="p">):</span>
                            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">5</span><span class="p">:]</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">py2_decode</span><span class="p">(</span><span class="n">unquote_plus</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log_debug</span><span class="p">(</span>
                    <span class="s1">&#39;Calling </span><span class="si">{0}</span><span class="s1"> with kwargs </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">route</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
                <span class="k">with</span> <span class="n">log_exception</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_error</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">route</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">SimplePluginError</span><span class="p">(</span>
            <span class="s1">&#39;No route matches the path &quot;</span><span class="si">{0}</span><span class="s1">&quot;!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s1">&#39;RoutedPlugin does not support action decorator. &#39;</span>
            <span class="s1">&#39;Use route decorator instead.&#39;</span>
        <span class="p">)</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">SimplePlugin</a></h1>



<p class="blurb">A plugin micro-framework for Kodi mediacenter</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=romanvm&repo=script.module.simpleplugin&type=star&v=2&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





    

<p>
<a class="badge" href="https://travis-ci.org/romanvm/script.module.simpleplugin">
    <img
        alt="https://secure.travis-ci.org/romanvm/script.module.simpleplugin.svg?branch=master"
        src="https://secure.travis-ci.org/romanvm/script.module.simpleplugin.svg?branch=master"
    />
</a>
</p>




    

<p>
<a class="badge" href="https://codecov.io/github/romanvm/script.module.simpleplugin">
    <img
    alt="https://codecov.io/github/romanvm/script.module.simpleplugin/coverage.svg?branch=master"
    src="https://codecov.io/github/romanvm/script.module.simpleplugin/coverage.svg?branch=master"
    />
</a>
</p>
<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../example.html">Minimal Example</a></li>
<li class="toctree-l1"><a class="reference internal" href="../actions_routing.html">Actions Routing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../storage.html">Persistent And In-Memory Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cached.html">Cached Decorator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../settings.html">Working with Plugin Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gettext.html">Plugin Localization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../log.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../debug.html">Debugging Addons</a></li>
<li class="toctree-l1"><a class="reference internal" href="../using.html">Using SimplePlugin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scrapers.html">Python Scrapers and Subtitle Addons</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../links.html">Useful Links</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Roman Miroshnychenko.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    
    <a href="https://github.com/romanvm/script.module.simpleplugin" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>